<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Collect_Shopping</title>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="../lib/http_code.jquery.com_jquery-2.0.0.js"></script>


    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="../lib/bootstrap-4.1.1-dist/js/bootstrap.bundle.js"></script>
    <script src="../lib/bootstrap-4.1.1-dist/js/bootstrap.js"></script>

    <script type="text/javascript" src="../lib/http_ajax.googleapis.com_ajax_libs_jqueryui_1.10.2_jquery-ui.js">
        $.widget.bridge('uitooltip', $.ui.tooltip);
        $.widget.bridge('uibutton', $.ui.button);
    </script>

    <link rel="stylesheet" href="../lib/tether-1.3.3/dist/css/tether.min.css">
    <link rel="stylesheet" href="../lib/bootstrap-4.1.1-dist/css/bootstrap.css">
    <link rel="stylesheet" href="../lib/bootstrap-4.1.1-dist/css/bootstrap-grid.css">
    <link rel="stylesheet" href="../lib/bootstrap-4.1.1-dist/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <ul class="nav nav-pills ">
                <li class="nav-item"><a class="nav-link" href="../index.html">Main</a></li>
                <li class="nav-item"><a class="nav-link" href="users_orders.html">User orders</a></li>
                <li class="nav-item " ><a class="nav-link " href="sites.html">Sites</a></li>
                <li class="nav-item" ><a class="nav-link" href="#">Delivery points</a></li>
                <li class="nav-item" ><a class="nav-link active" href="Geography.html">Geography</a></li>
                <li class="nav-item" ><a class="nav-link " href="Geo_structure.html">Geo-Structure</a></li>
            </ul>
        </div>
        <div class="col-lg-4">
            <div class="row" id="user" >
                <div class="col-lg-6 "><span> User name : </span><span>{{ name_value }}</span></div>
                <div class="col-lg-6"><span> User ID :</span><span> {{ ID_value }}</span> </div>
            </div>
        </div>
    </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="row">
                <div class="col-lg-12"><pre> </pre></div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                    <box id="country-box"
                         set-item-name="Country"
                         set-start-url="Get_list_countries.php"
                         set-add-url="Add_country.php"
                         set-edit-url="Edit_country.php"
                         set-clear-url="Del_country.php"
                         ref="countries">
                    </box>
                </div>
             </div>
              <div class="row">
                <div class="col-lg-12"><pre> </pre></div>
              </div>
            <div class="row">
                <div class="col-lg-8">
                    <div >
                        <box id="region-box"
                             set-item-name="Region"
                             set-start-url="Get_list_regions.php"
                             set-add-url="Add_region.php"
                             set-edit-url="Edit_region.php"
                             set-clear-url="Del_region.php"
                             ref="regions">
                        </box>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12"><pre> </pre></div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div >
                        <box id="city-box"
                             set-item-name="City"
                             set-start-url="Get_list_cities.php"
                             set-add-url="Add_city.php"
                             set-edit-url="Edit_city.php"
                             set-clear-url="Del_city.php"
                             ref="cities">
                        </box>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12"><pre> </pre></div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div >
                        <box id="area-box"
                             set-item-name="Area"
                             set-start-url="Get_list_areas.php"
                             set-add-url="Add_area.php"
                             set-edit-url="Edit_area.php"
                             set-clear-url="Del_area.php"
                             ref="areas">
                        </box>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12"><pre> </pre></div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div >
                        <box id="postcode-box"
                             set-item-name="Postcode"
                             set-start-url="Get_list_postcodes.php"
                             set-add-url="Add_postcode.php"
                             set-edit-url="Edit_postcode.php"
                             set-clear-url="Del_postcode.php"
                             ref="postcodes">
                        </box>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

<script>

    let user;
    user = new Vue({
        el: '#user',
        data: {
            name_value:"Vladimir",
            ID_value:"12345"
        }
    });

    Vue.component('box', {

        props:{setItemName:String,setStartUrl:String,setAddUrl:String,setEditUrl:String, setClearUrl:String},

        data: function () {
            return {
                mes:"",
                itemName:this.setItemName,
                options:[{
                    text:'',
                    id_item:0,
                    value:""
                }],
                selected:null,
                startUrl:this.setStartUrl,
                addUrl:this.setAddUrl,
                editUrl:this.setEditUrl,
                clearUrl:this.setClearUrl,
                id_current:0,
                input_field:false,
                new_item:"",
                child:[],
                parent:null,
                full_loaded:false,
                filter_id:0,
                edit_flag:false

            }
        },
        template: `<div>
                              <div v-if="mes!==''" class="row">
                                 <div  class="col-lg-12 ">
                                    <span>Message:  </span>
                                    <span v-bind:style="'color:red'">{{mes}}</span>
                                    <span>             </span>
                                    <button v-on:click="mes=''">ok</button>
                                  </div>
                              </div>
                              <div v-if="mes===''" class="row">
                                   <div class="col-lg-1 ">
                                       <span class="full_width" v-bind:style="'color:mediumblue'" >{{itemName}}</span>
                                   </div>
                                   <div class="col-lg-4 ">

                                       <select  v-model.lazy="selected" class="dropdown full_width" v-on:change="OnChangeBox" name="select_in_box">
                                           <option disabled value="">Select from ....</option>
                                           <option v-for="option in options" v-bind:value="option.value" v:key="option.value">
                                               {{option.text}}
                                           </option>
                                       </select>
                                    </div>
                                    <div class="col-lg-4 ">
                                       <input  v-model.trim.prevent="new_item"
                                                     placeholder="add new value and save"
                                                     type="text"
                                                     class="new_item full_width"
                                                     v-bind:text="new_item">

                                   </div>
                                   <div class="col-lg-1 ">
                                          <button  class="button_add, full_width" v-on:click="AddInBox" v-bind:style="'background-color:lime'" > New </button>
                                   </div>
                                   <div class="col-lg-1 ">
                                          <button  v-show="!edit_flag" class="button_edit_off full_width" v-on:click="EditOn" v-bind:style="'background-color:gold'" > Edit </button>
                                          <button  v-show="edit_flag" class="button_edit_on full_width" v-on:click="EditInBox"v-bind:style="'background-color:yellow'" > Save </button>
                                   </div>

                                   <div class="col-lg-1 ">
                                       <button class="button_del full_width" v-on:click="ClearFromBox" v-bind:style="'background-color:tomato'"> Delete </button>
                                   </div>
                               </div>
                           </div>`,

        methods : {

  //            created : function () { this.OnStartBox() },

              OnStartBox : function () {

                      const Init_list_box = function (start, link, filter_id) {

                          let jqxhr = $.get(start,{'filter_id':filter_id},"json");
                          jqxhr.done(function () {
                              try {
                                  options = JSON.parse(jqxhr.responseText);
                                  link.options = [{text: "", id_item: 0, value: ""}];
                                  for (let i = 0; i < options.length; i++) {
                                      link.options[i] = options[i];
                                  }
                                  link.selected = sessionStorage.getItem("select_" + link.itemName);

                                  if (link.selected !== null) {

                                      try {

                                          link.id_current = link.options.find(unit => unit.value === link.selected).id_item;
                                          count_trying_items = max_count_trying;
                                          link.full_loaded = true;
                                          link.mes = "";
                                      }
                                      catch (e) {
                                          link.id_current = 0;
                                          sessionStorage.setItem("select_" + link.itemName, "");
                                      }

                                      for (let i = 0; i < link.child.length; i++) {

                                          if (link.child[i] !== null) {
                                              link.child[i].filter_id = link.id_current;
                                              link.child[i].OnStartBox();
                                          }

                                      }

                                      return (true);
                                  }
                              }
                              catch (e) {
                                  link.mes = "Try connecting to SERVER ";
                                  if (count_trying_items < max_count_trying) {
                                      count_trying_items++;
                                      link.full_loaded = false;
                                      Init_list_box(start, link, filter_id);
                                  } else {
                                      link.mes = "SERVER not available, try later";
                                      link.full_loaded = false;
                                      return (false);
                                  }
                              }
                          });
                          jqxhr.fail(function () {
                              link.mes = "Try connecting to SERVER ";
                              if (count_trying_items < max_count_trying) {
                                  count_trying_items++;
                                  link.full_loaded = false;
                                  Init_list_box(start, link, filter_id);
                              } else {
                                  link.mes = "SERVER not available, try later";
                                  link.full_loaded = false;
                                  return (false);
                              }
                          });
                      };

                      let count_trying_items = 0;
                      let options = [];

                      let link = this;

                      if ( link.parent !== null && link.parent.full_loaded === false) { }

                      else {

                          Init_list_box(link.startUrl, link, link.filter_id);

                          for (let i=0; i<link.child.length; i++) {
                              if ((link.child[i] !== null) && (count_trying_items = max_count_trying)) {
                                  link.child[i].filter_id = link.id_current;
                                  link.child[i].OnStartBox();
                              }
                          }
                      }
                 },

              OnChangeBox  : function () {

                  if (this.selected !== null) {

                      sessionStorage.setItem("select_"+this.itemName,this.selected);
                      for (i=0; i<this.child.length; i++) {
                          if (this.child[i] !== null) {
                              sessionStorage.setItem("select_" + this.child[i].itemName, "");
                          }
                      }

                      try {

                          this.id_current = this.options.find(unit => unit.value === this.selected).id_item;

                      }
                      catch (e) {
                          this.selected = "";
                          this.id_current = 0;

                      }
                      for (let i=0; i<this.child.length; i++) {
                          if (this.child[i] !== null) {
                              this.child[i].filter_id = this.id_current;
                              Vue.nextTick(function () {
                              });
                              this.child[i].OnStartBox();
                          }
                      }
                  }
                  },

              AddInBox     : function () {
                  const Add_item = function (item, link) {

                      let parent_id; if (link.parent != null) { parent_id = link.parent.id_current} else {parent_id=0}

                      let jqxhr = $.post(link.addUrl,{"item":item,"parent_id":parent_id}, "json");
                      jqxhr.done(function () {
                          try {
                                let responce = JSON.parse(jqxhr.responseText);
                                link.mes = responce.message;
                                sessionStorage.setItem("select_" + link.itemName, item);
                                link.options[link.options.length]={text:item, id_item:responce.result, value:item};
                                link.id_current = responce.result;
                                link.selected = item;

                                if (link.selected !== null) {

                                 try {
                                      link.id_current = link.options.find(unit => unit.value === link.selected).id_item;
                                    }
                                    catch (e) {
                                        link.selected = "";
                                        link.id_current = 0;
                                        sessionStorage.setItem("select_" + link.itemName, "");
                                    }

                                        for (let i = 0; i < link.child.length; i++) {
                                            if (link.child[i] !== null) {
                                                link.child[i].filter_id = link.id_current;
                                                link.child[i].OnStartBox();
                                            }
                                    }
                                    return (true);
                                 }
                              }
                              catch (e) {
                                  link.mes = "SERVER not available, try later";
                                  return (false);
                              }
                          }
                      );
                      jqxhr.fail(function () {
                              link.mes = "SERVER not available, try later";
                              return (false);
                          })
                  };

                  let link = this;
                  let parent_id;
                  if (this.new_item !== "") {
                    if (link.parent != null) {
                           parent_id = link.parent.id_current;
                           if (parent_id !== 0) {Add_item(this.new_item,link)}
                    } else {parent_id=0; Add_item(this.new_item,link) }
                  }


              },

            EditOn : function () {
                  this.new_item = this.options.find(unit => unit.value === this.selected).text;
                  this.edit_flag = true;
            },

            EditInBox     : function () {
                const Edit_item = function (item, link) {

                    let jqxhr = $.post(link.editUrl,{"item":item,"id":link.id_current}, "json");
                    jqxhr.done(function () {
                            try {
                                let responce = JSON.parse(jqxhr.responseText);
                                link.mes = responce.message;
                                sessionStorage.setItem("select_" + link.itemName, item);

                                link.selected = item;

                                if (link.selected !== null) {

                                    try {
                                        let current_item = link.options.find(unit => unit.id_item === link.id_current);
                                        current_item.value = item;
                                        current_item.text = item;
                                        link.selected = current_item.value;
                                    }
                                    catch (e) {
                                        link.selected = "";
                                        link.id_current = 0;
                                        sessionStorage.setItem("select_" + link.itemName, "");
                                    }

                                        for (let i = 0; i < link.child.length; i++) {
                                            if (link.child[i] !== null) {
                                                link.child[i].filter_id = link.id_current;
                                                link.child[i].OnStartBox();
                                            }
                                    }
                                    return (true);
                                }
                            }
                            catch (e) {
                                link.mes = "SERVER not available, try later";
                                return (false);
                            }
                        }
                    );
                    jqxhr.fail(function () {
                        link.mes = "SERVER not available, try later";
                        return (false);
                    })
                };

                let link = this;
                this.edit_flag = false;
                if (this.new_item !== "") {Edit_item(this.new_item,link)}
                this.new_item = "";


            },


              ClearFromBox : function () {
                  const Del_item = function (item, link) {

                      let jqxhr = $.post(link.clearUrl,{"item":item}, "json");
                      jqxhr.done(function () {
                              try {
                                  let responce = JSON.parse(jqxhr.responseText);
                                  link.mes = responce.message;
                                  sessionStorage.setItem("select_"+link.itemName,"");
                                  return (true);
                              }
                              catch (e) {
                                  link.mes = "SERVER not available, try later";
                                  return (false);
                              }
                          }
                      );
                      jqxhr.fail(function () {
                          link.mes = "SERVER not available, try later";
                          return (false);
                      })
                  };

                  let link = this;

                  if (this.selected !== 0) {
                      let item=this.selected;
                      Del_item(item,link)
                  }



              }
        }
    });



    let max_count_trying=5;

    let country_box = new Vue({ el: '#country-box'});

    let region_box = new Vue({ el: '#region-box' });

    let city_box = new Vue({ el: '#city-box' });

    let area_box = new Vue({ el: '#area-box' });

    let postcode_box = new Vue({ el: '#postcode-box' });


    country_box.$refs.countries.child[0] = region_box.$refs.regions;

    region_box.$refs.regions.parent = country_box.$refs.countries;

    region_box.$refs.regions.child[0] = city_box.$refs.cities;

    city_box.$refs.cities.parent = region_box.$refs.regions;

    city_box.$refs.cities.child[0] = area_box.$refs.areas;

    area_box.$refs.areas.parent = city_box.$refs.cities;

    postcode_box.$refs.postcodes.parent = region_box.$refs.regions;

    region_box.$refs.regions.child[1] = postcode_box.$refs.postcodes;




    country_box.$refs.countries.OnStartBox(); // will change to hook

    region_box.$refs.regions.OnStartBox(); // will change to hook

    city_box.$refs.cities.OnStartBox(); // will change to hook

    postcode_box.$refs.postcodes.OnStartBox(); // will change to hook

    area_box.$refs.areas.OnStartBox(); // will change to hook




</script>

</body>
</html>